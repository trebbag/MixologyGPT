name: CI

on:
  push:
  pull_request:

jobs:
  api:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: bartender
          POSTGRES_PASSWORD: bartender
          POSTGRES_DB: bartenderai
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U bartender -d bartenderai"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql+asyncpg://bartender:bartender@localhost:5432/bartenderai
      REDIS_URL: redis://localhost:6379/0
      PYTHONPATH: .
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          cd services/api
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run migrations
        run: |
          cd services/api
          alembic upgrade head
      - name: Run API tests
        run: |
          cd services/api
          pytest tests/unit tests/integration tests/contract -q

  migration-smoke:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: bartender
          POSTGRES_PASSWORD: bartender
          POSTGRES_DB: bartenderai
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U bartender -d bartenderai"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql+asyncpg://bartender:bartender@localhost:5432/bartenderai
      PYTHONPATH: .
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          cd services/api
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Migration smoke on clean DB
        run: |
          cd services/api
          alembic upgrade head
          python - <<'PY'
          import asyncio
          from sqlalchemy.ext.asyncio import create_async_engine
          from sqlalchemy import text
          async def main():
              engine = create_async_engine("postgresql+asyncpg://bartender:bartender@localhost:5432/bartenderai")
              async with engine.connect() as conn:
                  result = await conn.execute(text("select count(*) from alembic_version"))
                  count = result.scalar_one()
                  assert count == 1, f"expected one alembic head, got {count}"
              await engine.dispose()
          asyncio.run(main())
          PY

  web-lint-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install dependencies
        run: |
          cd apps/web
          npm ci
      - name: Lint
        run: |
          cd apps/web
          npm run lint
      - name: Build
        run: |
          cd apps/web
          npm run build

  web-e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install dependencies
        run: |
          cd apps/web
          npm ci
      - name: Install Playwright browsers
        run: |
          cd apps/web
          npx playwright install --with-deps chromium
      - name: Run web E2E
        run: |
          cd apps/web
          npm run dev -- --hostname 127.0.0.1 --port 3000 >/tmp/web-dev.log 2>&1 &
          WEB_PID=$!
          for i in {1..60}; do
            if curl -sSf http://127.0.0.1:3000 >/dev/null; then
              break
            fi
            sleep 1
          done
          E2E_BASE_URL=http://127.0.0.1:3000 npm run test:e2e
          kill $WEB_PID

  mobile-mocked-e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install dependencies
        run: |
          cd apps/mobile
          npm ci
      - name: Typecheck
        run: |
          cd apps/mobile
          npm run typecheck
      - name: Run mocked E2E
        run: |
          cd apps/mobile
          npm run test:e2e
